<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µ - ä¸ªäººèµ„é‡‘ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: none;
            height: 100%;
        }
        .card-body.stats-card {
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .container {
            max-width: 1200px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html" style="font-weight: bold; font-size: 20px;">
                <i class="bi bi-wallet2"></i> è´·æ¬¾ç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html"><i class="bi bi-house-door"></i> é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="loans.html"><i class="bi bi-credit-card"></i> è´·æ¬¾ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="income-expenses.html"><i class="bi bi-cash-stack"></i> æ”¶å…¥æ”¯å‡º</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="repayment-plan.html"><i class="bi bi-calendar-check"></i> è¿˜æ¬¾è®¡åˆ’ â­</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="forecast.html"><i class="bi bi-graph-up"></i> å›ºå®šæ”¶æ”¯</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="salary-cycle.html"><i class="bi bi-calendar-range"></i> å·¥èµ„å‘¨æœŸ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="calendar.html"><i class="bi bi-calendar3"></i> è¿˜æ¬¾æ—¥å†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="debt-trend.html"><i class="bi bi-graph-down"></i> å€ºåŠ¡è¶‹åŠ¿</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container mt-4">
        <!-- æ ¸å¿ƒèµ„é‡‘æ¦‚è§ˆ -->
        <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div class="card-body p-4">
                <h4 class="mb-4" style="font-weight: bold;">
                    <i class="bi bi-wallet2"></i> èµ„é‡‘æ¦‚è§ˆ
                </h4>
                <div class="row text-center">
                    <!-- å½“å‰æœ‰å¤šå°‘é’± -->
                    <div class="col-md-3">
                        <div class="p-3">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">
                                <i class="bi bi-piggy-bank"></i> å½“å‰ä½™é¢
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #FFD54F;" id="currentBalance">Â¥0.00</div>
                            <button class="btn btn-sm btn-outline-light mt-2" onclick="updateBalance()" style="opacity: 0.8;">
                                <i class="bi bi-pencil"></i> æ›´æ–°
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ¯æœˆè¦è¿˜å¤šå°‘ -->
                    <div class="col-md-3">
                        <div class="p-3" style="border-left: 2px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">
                                <i class="bi bi-calendar-x"></i> æ¯æœˆè¦è¿˜
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #FFCDD2;" id="monthlyPayment">Â¥0.00</div>
                            <small style="opacity: 0.8;">è´·æ¬¾è¿˜æ¬¾</small>
                        </div>
                    </div>
                    
                    <!-- å›ºå®šæ”¯å‡º -->
                    <div class="col-md-3">
                        <div class="p-3" style="border-left: 2px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">
                                <i class="bi bi-cash-stack"></i> å›ºå®šæ”¯å‡º
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #FFCCBC;" id="monthlyExpense">Â¥0.00</div>
                            <small style="opacity: 0.8;">æœˆåº¦æ”¯å‡º</small>
                        </div>
                    </div>
                    
                    <!-- å‰©å¤šå°‘é’± -->
                    <div class="col-md-3">
                        <div class="p-3" style="border-left: 2px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">
                                <i class="bi bi-graph-up-arrow"></i> æ¯æœˆç»“ä½™
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #C8E6C9;" id="monthlySurplus">Â¥0.00</div>
                            <small style="opacity: 0.8;" id="surplusHint">æ”¶å…¥-è¿˜æ¬¾-æ”¯å‡º</small>
                        </div>
                    </div>
                </div>
                
                <!-- è®¡ç®—å…¬å¼æç¤º -->
                <div class="mt-3 pt-3" style="border-top: 2px solid rgba(255,255,255,0.2); text-align: center; opacity: 0.8; font-size: 13px;">
                    ğŸ’¡ æ¯æœˆç»“ä½™ = æœ¬æœˆæ”¶å…¥(<span id="incomeCalc">Â¥0</span>) - æ¯æœˆè¿˜æ¬¾(<span id="paymentCalc">Â¥0</span>) - å›ºå®šæ”¯å‡º(<span id="expenseCalc">Â¥0</span>)
                </div>
            </div>
        </div>

        <!-- é¢å¤–ä¿¡æ¯å¡ç‰‡ -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2"><i class="bi bi-exclamation-triangle"></i> æ€»è´Ÿå€º</h6>
                        <h2 class="amount-negative" id="totalDebt">Â¥0.00</h2>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="debtProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2"><i class="bi bi-arrow-down-circle"></i> æœ¬æœˆæ”¶å…¥</h6>
                        <h2 class="amount-positive" id="monthlyIncome">Â¥0.00</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šé¢„è­¦ä¿¡æ¯ -->
        <div id="warningArea"></div>

        <!-- ç¬¬å››è¡Œï¼šå¿«æ·æ“ä½œ -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning-charge"></i> å¿«æ·æ“ä½œ
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex">
                    <a href="repayment-plan.html" class="btn btn-danger">
                        <i class="bi bi-calendar-check"></i> â­ è¿˜æ¬¾è®¡åˆ’
                    </a>
                    <a href="chat-input.html" class="btn btn-success">
                        <i class="bi bi-chat-dots"></i> ğŸ’¬ æ™ºèƒ½å½•å…¥
                    </a>
                    <a href="loans.html" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> æ·»åŠ è´·æ¬¾
                    </a>
                    <a href="income-expenses.html" class="btn btn-warning text-white">
                        <i class="bi bi-plus-circle"></i> æ·»åŠ æ”¶å…¥
                    </a>
                    <a href="calendar.html" class="btn btn-info text-white">
                        <i class="bi bi-calendar3"></i> è¿˜æ¬¾æ—¥å†
                    </a>
                </div>
            </div>
        </div>

        <!-- è´·æ¬¾ç»Ÿè®¡ -->
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2"><i class="bi bi-clipboard-check"></i> æ´»è·ƒè´·æ¬¾</h6>
                        <h2 style="color: #667eea;" id="activeLoans">0</h2>
                        <small class="text-muted">ç¬”</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2"><i class="bi bi-check-circle"></i> å·²ç»“æ¸…</h6>
                        <h2 style="color: #4CAF50;" id="completedLoans">0</h2>
                        <small class="text-muted">ç¬”</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2"><i class="bi bi-building"></i> å¹³å°æ•°é‡</h6>
                        <h2 style="color: #FF9800;" id="platformCount">0</h2>
                        <small class="text-muted">ä¸ª</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ›´æ–°ä½™é¢æ¨¡æ€æ¡† -->
    <div class="modal fade" id="updateBalanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ›´æ–°ä½™é¢</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">å½“å‰ä½™é¢</label>
                        <input type="number" class="form-control" id="newBalance" step="0.01" placeholder="è¾“å…¥æ–°çš„ä½™é¢">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control" id="balanceDescription" placeholder="ä¾‹å¦‚ï¼šæ‰‹åŠ¨æ›´æ–°">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveBalance()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let updateBalanceModal;

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            updateBalanceModal = new bootstrap.Modal(document.getElementById('updateBalanceModal'));
            loadDashboardData();
        });

        // åŠ è½½é¦–é¡µæ•°æ®
        async function loadDashboardData() {
            try {
                const data = await API.dashboard.getData();
                const overview = await API.dashboard.getOverview();
                
                // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
                document.getElementById('currentBalance').textContent = 'Â¥' + Utils.formatMoney(data.currentBalance);
                document.getElementById('monthlyPayment').textContent = 'Â¥' + Utils.formatMoney(data.monthlyPayment);
                document.getElementById('monthlyExpense').textContent = 'Â¥' + Utils.formatMoney(data.monthlyExpense);
                document.getElementById('monthlyIncome').textContent = 'Â¥' + Utils.formatMoney(data.monthlyIncome);
                
                // æœ¬æœˆç»“ä½™
                const surplus = data.monthlySurplus;
                const surplusEl = document.getElementById('monthlySurplus');
                surplusEl.textContent = 'Â¥' + Utils.formatMoney(Math.abs(surplus));
                
                // æ›´æ–°è®¡ç®—å…¬å¼ä¸­çš„å€¼
                document.getElementById('incomeCalc').textContent = 'Â¥' + Utils.formatMoney(data.monthlyIncome);
                document.getElementById('paymentCalc').textContent = 'Â¥' + Utils.formatMoney(data.monthlyPayment);
                document.getElementById('expenseCalc').textContent = 'Â¥' + Utils.formatMoney(data.monthlyExpense);
                
                // æ ¹æ®ç»“ä½™æ­£è´Ÿæ”¹å˜é¢œè‰²
                if (surplus >= 0) {
                    surplusEl.style.color = '#A5D6A7';
                    document.getElementById('surplusHint').textContent = 'âœ“ æœ‰ç»“ä½™';
                } else {
                    surplusEl.style.color = '#EF5350';
                    document.getElementById('surplusHint').textContent = 'âš ï¸ ä¼šèµ¤å­—';
                }
                
                // é¢å¤–ä¿¡æ¯
                document.getElementById('totalDebt').textContent = 'Â¥' + Utils.formatMoney(data.totalDebt);
                
                // è´·æ¬¾æ±‡æ€»
                const summary = data.loanSummary;
                document.getElementById('activeLoans').textContent = summary.activeLoans;
                document.getElementById('completedLoans').textContent = summary.completedLoans;
                document.getElementById('platformCount').textContent = summary.platforms.length;
                
                // æ£€æŸ¥èµ¤å­—é¢„è­¦
                const deficitData = await API.forecast.getDeficit(3);
                if (deficitData.hasDeficit) {
                    showDeficitWarning(deficitData);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                Utils.showError('åŠ è½½æ•°æ®å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºèµ¤å­—é¢„è­¦
        function showDeficitWarning(data) {
            const warningArea = document.getElementById('warningArea');
            warningArea.innerHTML = `
                <div class="deficit-danger fade-in mb-4">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> èµ¤å­—é¢„è­¦</h5>
                    <p>${data.warning}</p>
                    <a href="forecast.html" class="btn btn-sm btn-danger">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            `;
        }

        // æ›´æ–°ä½™é¢
        function updateBalance() {
            API.balance.getCurrent().then(data => {
                document.getElementById('newBalance').value = data.balance;
            });
            updateBalanceModal.show();
        }

        // ä¿å­˜ä½™é¢
        async function saveBalance() {
            const balance = document.getElementById('newBalance').value;
            const description = document.getElementById('balanceDescription').value || 'æ‰‹åŠ¨æ›´æ–°';
            
            if (!balance) {
                alert('è¯·è¾“å…¥ä½™é¢');
                return;
            }
            
            try {
                await API.balance.update({ balance, description });
                updateBalanceModal.hide();
                loadDashboardData();
            } catch (error) {
                Utils.showError('æ›´æ–°å¤±è´¥');
            }
        }
    </script>
</body>
</html>

