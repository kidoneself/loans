<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿˜æ¬¾è§„åˆ’ - è´·æ¬¾ç®¡ç†ç³»ç»Ÿ v3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root { --primary-color: #4f46e5; --success-color: #10b981; --warning-color: #f59e0b; }
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .navbar { background: linear-gradient(135deg, var(--primary-color) 0%, #6366f1 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem; border-radius: 16px; margin-bottom: 2rem; text-align: center; }
        .countdown-box { background: rgba(255,255,255,0.2); border-radius: 12px; padding: 2rem; margin: 1rem 0; }
        .countdown-number { font-size: 4rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .stat-card { border: none; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; height: 100%; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .timeline-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; overflow-x: auto; }
        .timeline-item { background: white; border: 2px solid var(--warning-color); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .chart-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .progress-item { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar-custom { height: 10px; border-radius: 5px; background: #e5e7eb; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success-color) 0%, #34d399 100%); transition: width 0.3s; }
        .rank-badge { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; font-weight: 700; font-size: 0.875rem; }
        .rank-1 { background: #ffd700; color: #fff; }
        .rank-2 { background: #c0c0c0; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #e5e7eb; color: #6b7280; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-wallet2 me-2"></i>è´·æ¬¾ç®¡ç†ç³»ç»Ÿ v3.0</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house-door me-1"></i>é¦–é¡µ</a></li>
                    <li class="nav-item"><a class="nav-link" href="calendar.html"><i class="bi bi-calendar3 me-1"></i>æ—¥å†</a></li>
                    <li class="nav-item"><a class="nav-link" href="trend.html"><i class="bi bi-graph-up me-1"></i>è¶‹åŠ¿</a></li>
                    <li class="nav-item"><a class="nav-link active" href="plan.html"><i class="bi bi-calendar-check me-1"></i>è§„åˆ’</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="hero-section">
            <h1 class="mb-3"><i class="bi bi-trophy me-3"></i>è¿˜æ¬¾è§„åˆ’</h1>
            <div class="countdown-box">
                <div class="countdown-number" id="debtFreeCountdown">-</div>
                <h3>è·ç¦»å®Œå…¨æ— å€º</h3>
                <p class="mb-0" id="debtFreeDate">-</p>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="card stat-card"><div class="card-body"><small class="text-muted d-block mb-1">æœ€å¿«è¿˜æ¸…</small><h4 class="mb-0 text-success" id="fastestLoan">-</h4><small class="text-muted" id="fastestDays">-</small></div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="card-body"><small class="text-muted d-block mb-1">æœ€æ™šè¿˜æ¸…</small><h4 class="mb-0 text-warning" id="latestLoan">-</h4><small class="text-muted" id="latestDays">-</small></div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="card-body"><small class="text-muted d-block mb-1">å¹³å‡è¿›åº¦</small><h4 class="mb-0 text-primary" id="avgProgress">-</h4><small class="text-muted">æ‰€æœ‰è´·æ¬¾</small></div></div></div>
            <div class="col-md-3"><div class="card stat-card"><div class="card-body"><small class="text-muted d-block mb-1">æ€»å‰©ä½™æœŸæ•°</small><h4 class="mb-0 text-danger" id="totalRemaining">-</h4><small class="text-muted">åˆè®¡</small></div></div></div>
        </div>

        <div class="timeline-container">
            <h5 class="mb-3"><i class="bi bi-calendar-event me-2"></i>è¿˜æ¸…æ—¶é—´çº¿</h5>
            <div id="timelineList"></div>
        </div>

        <div class="chart-card mb-4">
            <h5 class="mb-3"><i class="bi bi-graph-down me-2"></i>æœªæ¥æœˆä¾›è¶‹åŠ¿</h5>
            <canvas id="paymentChart" height="80"></canvas>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-speedometer2 me-2"></i>è¿˜æ¬¾è¿›åº¦æ’è¡Œ</h5>
                    <div id="progressRanking"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="bi bi-alarm me-2"></i>è¿˜æ¸…æ—¶é—´æ’è¡Œ</h5>
                    <div id="timeRanking"></div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>è´·æ¬¾è¿›åº¦è¯¦æƒ…</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group btn-group-sm" role="group" id="sortButtons">
                        <button type="button" class="btn btn-outline-primary active" data-sort="time" onclick="sortDetails('time')">
                            <i class="bi bi-clock me-1"></i>æŒ‰æ—¶é—´
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-sort="progress" onclick="sortDetails('progress')">
                            <i class="bi bi-speedometer2 me-1"></i>æŒ‰è¿›åº¦
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-sort="amount" onclick="sortDetails('amount')">
                            <i class="bi bi-currency-dollar me-1"></i>æŒ‰é‡‘é¢
                        </button>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="orderButton" onclick="toggleOrder()">
                        <i class="bi bi-sort-down" id="orderIcon"></i>
                        <span id="orderText">é™åº</span>
                    </button>
                </div>
            </div>
            <div id="progressList"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let chart;
        let currentLoansData = [];
        let currentSort = 'time';
        let isDescending = true;

        document.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/loans`);
                const allLoans = await response.json();
                const activeLoans = allLoans.filter(l => l.status === 'active');

                const loansData = [];
                for (const loan of activeLoans) {
                    const schedRes = await fetch(`${API_BASE}/schedules/loan/${loan.id}`);
                    const schedules = await schedRes.json();
                    const pending = schedules.filter(s => s.status === 'pending');
                    const paid = schedules.filter(s => s.status === 'paid');
                    
                    if (pending.length > 0) {
                        const lastDue = new Date(pending[pending.length - 1].dueDate);
                        const days = Math.ceil((lastDue - new Date()) / 86400000);
                        loansData.push({
                            name: loan.name,
                            platform: loan.platform,
                            monthlyAmount: loan.monthlyAmount,
                            total: schedules.length,
                            paid: paid.length,
                            remaining: pending.length,
                            progress: ((paid.length / schedules.length) * 100).toFixed(1),
                            days: days,
                            finishDate: lastDue,
                            remainingAmount: pending.reduce((sum, s) => sum + s.amount, 0)
                        });
                    }
                }

                if (loansData.length === 0) {
                    document.getElementById('debtFreeCountdown').textContent = 'ğŸ‰';
                    document.getElementById('debtFreeDate').textContent = 'æ­å–œï¼å·²æ— å€ºä¸€èº«è½»ï¼';
                    return;
                }

                currentLoansData = loansData;
                renderCountdown(loansData);
                renderMetrics(loansData);
                renderTimeline(loansData);
                renderChart(loansData);
                renderRankings(loansData);
                renderDetails(loansData, currentSort, isDescending);
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        function renderCountdown(data) {
            const latest = data.reduce((max, item) => item.days > max.days ? item : max);
            document.getElementById('debtFreeCountdown').textContent = latest.days + ' å¤©';
            document.getElementById('debtFreeDate').textContent = 'é¢„è®¡ ' + latest.finishDate.toLocaleDateString('zh-CN');
        }

        function renderMetrics(data) {
            const fastest = data.reduce((min, item) => item.remaining < min.remaining ? item : min);
            const latest = data.reduce((max, item) => item.remaining > max.remaining ? item : max);
            const avgProgress = (data.reduce((sum, item) => sum + parseFloat(item.progress), 0) / data.length).toFixed(1);
            const totalRemaining = data.reduce((sum, item) => sum + item.remaining, 0);

            document.getElementById('fastestLoan').textContent = fastest.name;
            document.getElementById('fastestDays').textContent = `è¿˜å‰©${fastest.remaining}æœŸ Â· ${fastest.days}å¤©`;
            document.getElementById('latestLoan').textContent = latest.name;
            document.getElementById('latestDays').textContent = `è¿˜å‰©${latest.remaining}æœŸ Â· ${latest.days}å¤©`;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
            document.getElementById('totalRemaining').textContent = totalRemaining + 'æœŸ';
        }

        function renderTimeline(data) {
            const sorted = [...data].sort((a, b) => a.days - b.days);
            let html = '';
            sorted.forEach((item, idx) => {
                html += `
                    <div class="timeline-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${item.name} <small class="text-muted">${item.platform}</small></h6>
                                <small class="text-muted">é¢„è®¡è¿˜æ¸…ï¼š${item.finishDate.toLocaleDateString('zh-CN')}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning">${item.remaining}æœŸ</span>
                                <div><small class="text-muted">${item.days}å¤©å</small></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('timelineList').innerHTML = html;
        }

        function renderChart(data) {
            const months = [];
            const values = [];
            const today = new Date();
            
            for (let i = 0; i < 12; i++) {
                const month = new Date(today);
                month.setMonth(month.getMonth() + i);
                months.push(month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2, '0'));
                
                let total = 0;
                data.forEach(item => {
                    if (item.finishDate >= month) total += item.monthlyAmount;
                });
                values.push(total);
            }

            const ctx = document.getElementById('paymentChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'æœˆä¾›',
                        data: values,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245,158,11,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => 'Â¥' + (v/1000).toFixed(0) + 'K' }
                        }
                    }
                }
            });
        }

        function renderRankings(data) {
            const byProgress = [...data].sort((a, b) => parseFloat(b.progress) - parseFloat(a.progress));
            let html1 = '';
            byProgress.forEach((item, idx) => {
                const rank = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                html1 += `
                    <div class="d-flex align-items-center mb-3">
                        <div class="rank-badge ${rank} me-3">${idx + 1}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fw-bold">${item.name}</span>
                                <span class="badge bg-primary">${item.progress}%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${item.progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('progressRanking').innerHTML = html1;

            const byTime = [...data].sort((a, b) => a.remaining - b.remaining);
            let html2 = '';
            byTime.forEach((item, idx) => {
                const rank = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                html2 += `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="rank-badge ${rank} me-3">${idx + 1}</div>
                            <div>
                                <div class="fw-bold">${item.name}</div>
                                <small class="text-muted">${item.platform}</small>
                            </div>
                        </div>
                        <span class="badge bg-warning">${item.remaining}æœŸ</span>
                    </div>
                `;
            });
            document.getElementById('timeRanking').innerHTML = html2;
        }

        function sortDetails(sortType) {
            currentSort = sortType;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#sortButtons button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sort === sortType) {
                    btn.classList.add('active');
                }
            });
            
            // é‡æ–°æ¸²æŸ“
            renderDetails(currentLoansData, sortType, isDescending);
        }
        
        function toggleOrder() {
            isDescending = !isDescending;
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const icon = document.getElementById('orderIcon');
            const text = document.getElementById('orderText');
            
            if (isDescending) {
                icon.className = 'bi bi-sort-down';
                text.textContent = 'é™åº';
            } else {
                icon.className = 'bi bi-sort-up';
                text.textContent = 'å‡åº';
            }
            
            // é‡æ–°æ¸²æŸ“
            renderDetails(currentLoansData, currentSort, isDescending);
        }

        function renderDetails(data, sortType = 'time', descending = true) {
            // æ ¹æ®æ’åºç±»å‹æ’åº
            // é™åºï¼šæ—¶é—´ï¼ˆæœŸæ•°å°‘ï¼‰ã€è¿›åº¦ï¼ˆé«˜ï¼‰ã€é‡‘é¢ï¼ˆå¤šï¼‰
            // å‡åºï¼šæ—¶é—´ï¼ˆæœŸæ•°å¤šï¼‰ã€è¿›åº¦ï¼ˆä½ï¼‰ã€é‡‘é¢ï¼ˆå°‘ï¼‰
            let sorted = [...data];
            if (sortType === 'time') {
                // é™åºï¼šå¿«è¿˜å®Œçš„åœ¨å‰ï¼ˆæœŸæ•°å°‘ï¼‰ï¼›å‡åºï¼šæ…¢çš„åœ¨å‰ï¼ˆæœŸæ•°å¤šï¼‰
                sorted.sort((a, b) => descending ? a.remaining - b.remaining : b.remaining - a.remaining);
            } else if (sortType === 'progress') {
                // é™åºï¼šè¿›åº¦é«˜çš„åœ¨å‰ï¼›å‡åºï¼šè¿›åº¦ä½çš„åœ¨å‰
                sorted.sort((a, b) => descending ? parseFloat(b.progress) - parseFloat(a.progress) : parseFloat(a.progress) - parseFloat(b.progress));
            } else if (sortType === 'amount') {
                // é™åºï¼šæ¬ å¾—å¤šçš„åœ¨å‰ï¼›å‡åºï¼šæ¬ å¾—å°‘çš„åœ¨å‰
                sorted.sort((a, b) => descending ? b.remainingAmount - a.remainingAmount : a.remainingAmount - b.remainingAmount);
            }
            
            let html = '';
            sorted.forEach(item => {
                html += `
                    <div class="progress-item">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1">${item.name}</h5>
                                <small class="text-muted">${item.platform}</small>
                            </div>
                            <span class="badge bg-warning fs-6">${item.remaining}æœŸ</span>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <small class="text-muted d-block">è¿˜æ¬¾è¿›åº¦</small>
                                <strong class="text-primary">${item.paid}/${item.total}æœŸ (${item.progress}%)</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">å‰©ä½™é‡‘é¢</small>
                                <strong class="text-danger">Â¥${item.remainingAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">æœˆä¾›</small>
                                <strong>Â¥${item.monthlyAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">è¿˜æ¸…æ—¥æœŸ</small>
                                <strong class="text-success">${item.finishDate.toLocaleDateString('zh-CN')}</strong>
                            </div>
                        </div>
                        <div class="progress-bar-custom">
                            <div class="progress-fill" style="width: ${item.progress}%"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('progressList').innerHTML = html;
        }
    </script>
</body>
</html>
