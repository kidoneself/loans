<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款详情 - 贷款管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: none;
        }
        .container {
            max-width: 1200px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #666;
            font-weight: 500;
        }
        .info-value {
            font-weight: bold;
            color: #333;
        }
        .progress-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .payment-timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #667eea;
        }
        .timeline-item.paid {
            border-left-color: #4CAF50;
            background: #E8F5E9;
        }
        .timeline-item.paid::before {
            background: #4CAF50;
            box-shadow: 0 0 0 2px #4CAF50;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html" style="font-weight: bold; font-size: 20px;">
                <i class="bi bi-wallet2"></i> 贷款管理系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> 首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="loans.html"><i class="bi bi-credit-card"></i> 贷款管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="income-expenses.html"><i class="bi bi-cash-stack"></i> 收入支出</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="repayment-plan.html"><i class="bi bi-calendar-check"></i> 还款计划 ⭐</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="forecast.html"><i class="bi bi-graph-up"></i> 固定收支</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="salary-cycle.html"><i class="bi bi-calendar-range"></i> 工资周期</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="calendar.html"><i class="bi bi-calendar3"></i> 还款日历</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="debt-trend.html"><i class="bi bi-graph-down"></i> 债务趋势</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 返回按钮 -->
        <div class="mb-3">
            <button class="btn btn-outline-light" onclick="window.location.href='loans.html'">
                <i class="bi bi-arrow-left"></i> 返回贷款列表
            </button>
        </div>

        <div class="row">
            <!-- 左侧：基本信息 -->
            <div class="col-md-8">
                <!-- 贷款概览 -->
                <div class="card mb-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            <span id="loanNameTitle">贷款详情</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">贷款名称</span>
                                    <span class="info-value" id="detailLoanName">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">所属平台</span>
                                    <span class="info-value" id="detailPlatform">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">每月还款</span>
                                    <span class="info-value" style="color: #FF9800;" id="detailMonthlyPayment">¥0.00</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">还款日期</span>
                                    <span class="info-value" id="detailPaymentDay">-</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">总期数</span>
                                    <span class="info-value" id="detailTotalPeriods">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">已还期数</span>
                                    <span class="info-value" style="color: #4CAF50;" id="detailPaidPeriods">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">剩余期数</span>
                                    <span class="info-value" style="color: #2196F3;" id="detailRemainingPeriods">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">剩余总金额</span>
                                    <span class="info-value" style="color: #f44336; font-size: 20px;" id="detailRemainingAmount">¥0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3" style="border-top: 2px dashed #e0e0e0;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">总借款金额</span>
                                        <span class="info-value" id="detailTotalAmount">-</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">开始日期</span>
                                        <span class="info-value" id="detailStartDate">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info-item" v-if="loan.note">
                                <span class="info-label">备注</span>
                                <span class="info-value" id="detailNote">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 还款计划 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-calendar-week"></i> 未来还款计划
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>期数</th>
                                        <th>预计日期</th>
                                        <th>应还金额</th>
                                    </tr>
                                </thead>
                                <tbody id="futurePaymentsTable">
                                    <!-- JS动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 还款历史 -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> 还款历史
                    </div>
                    <div class="card-body">
                        <div class="payment-timeline" id="paymentHistory">
                            <p class="text-muted">暂无还款记录</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：进度和操作 -->
            <div class="col-md-4">
                <!-- 还款进度 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> 还款进度
                    </div>
                    <div class="card-body text-center">
                        <div class="progress-circle mb-3">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#f0f0f0" stroke-width="8"/>
                                <circle id="progressCircle" cx="50" cy="50" r="45" fill="none" stroke="#4CAF50" 
                                        stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283"
                                        transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 1s ease;"/>
                                <text x="50" y="50" text-anchor="middle" dy="7" font-size="20" font-weight="bold" fill="#333">
                                    <tspan id="progressText">0%</tspan>
                                </text>
                            </svg>
                        </div>
                        <div class="text-muted">
                            已还 <strong id="paidPeriodsDisplay">0</strong> 期 / 共 <strong id="totalPeriodsDisplay">0</strong> 期
                        </div>
                    </div>
                </div>

                <!-- 快捷操作 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-lightning"></i> 快捷操作
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="recordPayment()">
                                <i class="bi bi-cash-coin"></i> 记录还款
                            </button>
                            <button class="btn btn-primary" onclick="editLoan()">
                                <i class="bi bi-pencil"></i> 编辑信息
                            </button>
                            <button class="btn btn-danger" onclick="deleteLoan()">
                                <i class="bi bi-trash"></i> 删除贷款
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calculator"></i> 统计信息
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">预计还清日期</span>
                            <span class="info-value" id="payoffDate">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">已还总金额</span>
                            <span class="info-value" style="color: #4CAF50;" id="paidTotal">¥0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">剩余还款月数</span>
                            <span class="info-value" style="color: #2196F3;" id="remainingMonths">-</span>
                        </div>
                    </div>
                </div>

                <!-- 利息计算 -->
                <div class="card mt-3">
                    <div class="card-header" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">
                        <i class="bi bi-percent"></i> 利息计算
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">总借款金额</span>
                            <span class="info-value" id="interestTotalAmount">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">总还款金额</span>
                            <span class="info-value" id="totalRepayment">-</span>
                        </div>
                        <div class="info-item" style="background: #FFF3E0; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <span class="info-label" style="font-weight: bold;">利息总额</span>
                            <span class="info-value" style="color: #F57C00; font-size: 24px; font-weight: bold;" id="totalInterest">¥0.00</span>
                        </div>
                        <div class="mt-2 text-center" style="font-size: 12px; color: #666;">
                            <i class="bi bi-info-circle"></i> 
                            利息 = 总还款(<span id="repayCalc">0</span>期 × <span id="monthlyCalc">¥0</span>) - 总借款
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loanId = null;
        let loan = null;

        // 页面加载时获取贷款ID
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            loanId = params.get('id');
            
            if (!loanId) {
                alert('未指定贷款ID');
                window.location.href = 'loans.html';
                return;
            }
            
            loadLoanDetail();
            loadPaymentHistory();
        };

        // 加载贷款详情
        async function loadLoanDetail() {
            try {
                // 调用增强的详情API
                const response = await fetch(`${API_BASE_URL}/loans/${loanId}/detail`);
                const detail = await response.json();
                
                loan = detail.loan;
                
                displayLoanDetail(loan, detail);
                displayFuturePayments(loan);
            } catch (error) {
                console.error('加载贷款详情失败:', error);
                alert('加载失败');
            }
        }

        // 显示贷款详情
        function displayLoanDetail(loan, detail) {
            document.getElementById('loanNameTitle').textContent = loan.loanName || '贷款详情';
            document.getElementById('detailLoanName').textContent = loan.loanName || '-';
            document.getElementById('detailPlatform').textContent = loan.platform || '-';
            document.getElementById('detailMonthlyPayment').textContent = loan.monthlyPayment ? '¥' + loan.monthlyPayment.toFixed(2) : '¥0.00';
            document.getElementById('detailPaymentDay').textContent = loan.paymentDay ? '每月 ' + loan.paymentDay + ' 号' : '-';
            document.getElementById('detailTotalPeriods').textContent = loan.totalPeriods ? loan.totalPeriods + ' 期' : '-';
            document.getElementById('detailPaidPeriods').textContent = (loan.paidPeriods !== null && loan.paidPeriods !== undefined) ? loan.paidPeriods + ' 期' : '0 期';
            
            // 使用后端计算的值
            const remainingPeriods = detail.remainingPeriods || 0;
            document.getElementById('detailRemainingPeriods').textContent = remainingPeriods + ' 期';
            document.getElementById('detailRemainingAmount').textContent = loan.remainingAmount ? '¥' + loan.remainingAmount.toFixed(2) : '¥0.00';
            document.getElementById('detailTotalAmount').textContent = loan.totalAmount ? '¥' + loan.totalAmount.toFixed(2) : '-';
            document.getElementById('detailStartDate').textContent = loan.startDate || '-';
            
            // 备注特殊处理
            const noteElement = document.getElementById('detailNote');
            if (noteElement) {
                noteElement.textContent = loan.note || '-';
            }

            // 更新进度圆环
            if (loan.totalPeriods) {
                const progress = ((loan.paidPeriods || 0) / loan.totalPeriods) * 100;
                const circle = document.getElementById('progressCircle');
                const offset = 283 - (283 * progress / 100);
                circle.style.strokeDashoffset = offset;
                document.getElementById('progressText').textContent = Math.round(progress) + '%';
                
                document.getElementById('paidPeriodsDisplay').textContent = loan.paidPeriods || 0;
                document.getElementById('totalPeriodsDisplay').textContent = loan.totalPeriods;
            }

            // 使用后端计算的统计信息
            if (detail.paidTotal) {
                document.getElementById('paidTotal').textContent = '¥' + detail.paidTotal.toFixed(2);
            }
            document.getElementById('remainingMonths').textContent = remainingPeriods + ' 个月';

            // 使用后端计算的还清日期
            if (detail.payoffDate) {
                const payoffDate = new Date(detail.payoffDate);
                document.getElementById('payoffDate').textContent = payoffDate.toLocaleDateString('zh-CN');
            } else {
                document.getElementById('payoffDate').textContent = remainingPeriods > 0 ? '-' : '已还清';
            }

            // 使用后端计算的利息
            if (detail.totalInterest !== undefined && detail.totalRepayment !== undefined) {
                document.getElementById('interestTotalAmount').textContent = '¥' + loan.totalAmount.toFixed(2);
                document.getElementById('totalRepayment').textContent = '¥' + detail.totalRepayment.toFixed(2);
                document.getElementById('totalInterest').textContent = '¥' + detail.totalInterest.toFixed(2);
                document.getElementById('repayCalc').textContent = loan.totalPeriods;
                document.getElementById('monthlyCalc').textContent = '¥' + loan.monthlyPayment.toFixed(2);
            } else {
                document.getElementById('interestTotalAmount').textContent = '-';
                document.getElementById('totalRepayment').textContent = '-';
                document.getElementById('totalInterest').textContent = '-';
                document.getElementById('repayCalc').textContent = '?';
                document.getElementById('monthlyCalc').textContent = '¥?';
            }
        }

        // 显示未来还款计划
        function displayFuturePayments(loan) {
            const tbody = document.getElementById('futurePaymentsTable');
            tbody.innerHTML = '';
            
            const remainingPeriods = (loan.totalPeriods || 0) - (loan.paidPeriods || 0);
            const today = new Date();
            
            for (let i = 1; i <= Math.min(remainingPeriods, 12); i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i - 1);
                date.setDate(loan.paymentDay);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>第 ${(loan.paidPeriods || 0) + i} 期</td>
                    <td>${date.toLocaleDateString('zh-CN')}</td>
                    <td><strong style="color: #FF9800;">¥${loan.monthlyPayment.toFixed(2)}</strong></td>
                `;
            }
            
            if (remainingPeriods > 12) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="3" class="text-center text-muted">
                        还有 ${remainingPeriods - 12} 期未显示...
                    </td>
                `;
            }
        }

        // 加载还款历史
        async function loadPaymentHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/loans/${loanId}/payment-history`);
                const history = await response.json();
                
                const container = document.getElementById('paymentHistory');
                
                if (history.length === 0) {
                    container.innerHTML = '<p class="text-muted">暂无还款记录</p>';
                    return;
                }
                
                container.innerHTML = history.map(payment => `
                    <div class="timeline-item paid">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${payment.paymentDate}</strong>
                                <div class="text-muted" style="font-size: 13px;">${payment.note || '还款'}</div>
                            </div>
                            <div>
                                <strong style="color: #4CAF50; font-size: 18px;">¥${payment.paymentAmount.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载还款历史失败:', error);
            }
        }

        // 记录还款
        function recordPayment() {
            // 跳转到日历页面
            window.location.href = 'calendar.html';
        }

        // 编辑贷款
        function editLoan() {
            window.location.href = `loans.html?edit=${loanId}`;
        }

        // 删除贷款
        async function deleteLoan() {
            if (!confirm(`确定要删除贷款「${loan.loanName}」吗？\n\n此操作不可恢复！`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/loans/${loanId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('✓ 删除成功');
                    window.location.href = 'loans.html';
                } else {
                    throw new Error('删除失败');
                }
            } catch (error) {
                console.error('删除失败:', error);
                alert('❌ 删除失败：' + error.message);
            }
        }
    </script>
</body>
</html>

