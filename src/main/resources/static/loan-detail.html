<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款详情 - 贷款管理系统 v3.0</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }
        
        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #6366f1 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .info-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .schedule-item {
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .schedule-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .schedule-item.paid {
            background-color: #f0fdf4;
            border-left: 3px solid var(--success-color);
        }
        
        .schedule-item.pending {
            background-color: #fffbeb;
            border-left: 3px solid var(--warning-color);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-wallet2 me-2"></i>
                贷款管理系统 v3.0
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-door me-1"></i>首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="calendar.html">
                            <i class="bi bi-calendar3 me-1"></i>日历
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trend.html">
                            <i class="bi bi-graph-up me-1"></i>趋势
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="plan.html">
                            <i class="bi bi-calendar-check me-1"></i>规划
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 返回按钮 -->
        <div class="mb-4">
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回首页
            </a>
        </div>
        
        <!-- 还款模态框 -->
        <div class="modal fade" id="paymentModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">记录还款</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">还款金额</label>
                            <input type="number" class="form-control" id="paymentAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">还款日期</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-success" onclick="confirmPayment()">
                            <i class="bi bi-check-lg me-2"></i>确认还款
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 贷款基本信息 -->
        <div class="card info-card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h3 class="mb-3" id="loanName">-</h3>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <small class="text-muted d-block">贷款平台</small>
                                <strong id="platform">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">借款本金</small>
                                <strong class="text-primary" id="principal">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">月还款额</small>
                                <strong id="monthlyAmount">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">总期数</small>
                                <strong id="totalPeriods">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">每月还款日</small>
                                <strong id="paymentDay">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">首期还款日期</small>
                                <strong id="startDate">-</strong>
                            </div>
                        </div>
                        <div class="mt-3" id="noteContainer" style="display: none;">
                            <small class="text-muted d-block">备注</small>
                            <p class="mb-0" id="note"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-4 bg-light rounded">
                            <p class="text-muted mb-2">还款进度</p>
                            <h2 class="mb-0" id="progressPercent">0%</h2>
                            <p class="text-muted mb-3" id="progressText">0/0期</p>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                            </div>
                            <p class="text-muted mt-3 mb-1">剩余金额</p>
                            <h4 class="text-danger mb-0" id="remainingAmount">¥0.00</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 还款计划 -->
        <div class="card info-card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>还款计划
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="filterSchedules('all')">
                            全部 <span class="badge bg-secondary ms-1" id="countAll">0</span>
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterSchedules('pending')">
                            待还 <span class="badge bg-warning ms-1" id="countPending">0</span>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterSchedules('paid')">
                            已还 <span class="badge bg-success ms-1" id="countPaid">0</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="schedulesList">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE = '/api';
        let allSchedules = [];
        let currentFilter = 'all';
        
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const loanId = urlParams.get('id');
        
        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            if (!loanId) {
                alert('缺少贷款ID参数');
                window.location.href = '/';
                return;
            }
            loadLoanDetail();
            loadSchedules();
        });
        
        // 加载贷款详情
        async function loadLoanDetail() {
            try {
                const response = await fetch(`${API_BASE}/loans/${loanId}`);
                const loan = await response.json();
                
                document.getElementById('loanName').textContent = loan.name;
                document.getElementById('platform').textContent = loan.platform;
                document.getElementById('principal').textContent = 
                    '¥' + loan.principal.toLocaleString('zh-CN', {minimumFractionDigits: 2});
                document.getElementById('monthlyAmount').textContent = 
                    '¥' + loan.monthlyAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2});
                document.getElementById('totalPeriods').textContent = loan.totalPeriods + '期';
                document.getElementById('paymentDay').textContent = '每月' + loan.paymentDay + '号';
                document.getElementById('startDate').textContent = loan.startDate;
                
                if (loan.note) {
                    document.getElementById('noteContainer').style.display = 'block';
                    document.getElementById('note').textContent = loan.note;
                }
            } catch (error) {
                console.error('加载贷款详情失败:', error);
            }
        }
        
        // 加载还款计划
        async function loadSchedules() {
            try {
                const response = await fetch(`${API_BASE}/schedules/loan/${loanId}`);
                allSchedules = await response.json();
                
                // 计算统计
                const paidCount = allSchedules.filter(s => s.status === 'paid').length;
                const pendingCount = allSchedules.filter(s => s.status === 'pending').length;
                const totalCount = allSchedules.length;
                
                const progress = totalCount > 0 ? (paidCount / totalCount * 100).toFixed(1) : 0;
                const remainingAmount = allSchedules
                    .filter(s => s.status === 'pending')
                    .reduce((sum, s) => sum + s.amount, 0);
                
                // 更新进度
                document.getElementById('progressPercent').textContent = progress + '%';
                document.getElementById('progressText').textContent = `${paidCount}/${totalCount}期`;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('remainingAmount').textContent = 
                    '¥' + remainingAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2});
                
                // 更新计数
                document.getElementById('countAll').textContent = totalCount;
                document.getElementById('countPaid').textContent = paidCount;
                document.getElementById('countPending').textContent = pendingCount;
                
                // 显示列表
                renderSchedules();
            } catch (error) {
                console.error('加载还款计划失败:', error);
            }
        }
        
        // 渲染还款计划列表
        function renderSchedules() {
            const container = document.getElementById('schedulesList');
            let schedules = allSchedules;
            
            // 过滤
            if (currentFilter !== 'all') {
                schedules = allSchedules.filter(s => s.status === currentFilter);
            }
            
            if (schedules.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">暂无数据</p>';
                return;
            }
            
            container.innerHTML = '';
            schedules.forEach(schedule => {
                const statusText = {
                    'paid': '已还',
                    'pending': '待还'
                }[schedule.status] || schedule.status;
                
                const statusColor = {
                    'paid': 'success',
                    'pending': 'warning'
                }[schedule.status] || 'secondary';
                
                container.innerHTML += `
                    <div class="card schedule-item ${schedule.status}">
                        <div class="card-body py-2 px-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <span class="badge bg-${statusColor}">${statusText}</span>
                                </div>
                                <div class="col-auto">
                                    <strong>第${schedule.period}期</strong>
                                </div>
                                <div class="col">
                                    <small class="text-muted">
                                        应还日期: ${schedule.dueDate}
                                        ${schedule.paidDate ? ` | 实还日期: ${schedule.paidDate}` : ''}
                                    </small>
                                </div>
                                <div class="col-auto">
                                    <strong class="text-${statusColor}">
                                        ¥${schedule.amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}
                                    </strong>
                                </div>
                                ${schedule.status === 'pending' ? `
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-success" onclick="paySchedule(${schedule.id})">
                                            <i class="bi bi-check-lg me-1"></i>还款
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // 过滤还款计划
        function filterSchedules(filter) {
            currentFilter = filter;
            
            // 更新按钮状态
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('button').classList.add('active');
            
            renderSchedules();
        }
        
        // 临时存储当前还款的计划ID
        let currentScheduleId = null;
        
        // 显示还款模态框
        function paySchedule(scheduleId) {
            currentScheduleId = scheduleId;
            
            // 从列表中找到对应的计划，自动填充金额
            const schedule = allSchedules.find(s => s.id === scheduleId);
            if (schedule) {
                document.getElementById('paymentAmount').value = schedule.amount;
            }
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // 确认还款
        async function confirmPayment() {
            if (!currentScheduleId) return;
            
            const amount = document.getElementById('paymentAmount').value;
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (!amount || !paymentDate) {
                alert('请填写完整信息');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/schedules/${currentScheduleId}/pay?amount=${amount}&paymentDate=${paymentDate}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    loadSchedules();
                } else {
                    alert('还款记录失败');
                }
            } catch (error) {
                console.error('还款失败:', error);
                alert('还款记录失败');
            } finally {
                currentScheduleId = null;
            }
        }
    </script>
</body>
</html>
