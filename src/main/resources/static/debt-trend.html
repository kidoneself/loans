<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€ºåŠ¡è¶‹åŠ¿ - ä¸ªäººèµ„é‡‘ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: none;
        }
        .container {
            max-width: 1400px;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin: 10px 0;
        }
        .stat-card .trend-indicator {
            font-size: 1.2rem;
        }
        .btn-group-toggle .btn {
            min-width: 80px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html" style="font-weight: bold; font-size: 20px;">
                <i class="bi bi-wallet2"></i> è´·æ¬¾ç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="loans.html"><i class="bi bi-credit-card"></i> è´·æ¬¾ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="income-expenses.html"><i class="bi bi-cash-stack"></i> æ”¶å…¥æ”¯å‡º</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="forecast.html"><i class="bi bi-graph-up"></i> å›ºå®šæ”¶æ”¯</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="salary-cycle.html"><i class="bi bi-calendar-range"></i> å·¥èµ„å‘¨æœŸ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="calendar.html"><i class="bi bi-calendar3"></i> è¿˜æ¬¾æ—¥å†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="debt-trend.html"><i class="bi bi-graph-down"></i> å€ºåŠ¡è¶‹åŠ¿</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stat-card">
                    <div><i class="bi bi-wallet2" style="font-size: 2rem;"></i></div>
                    <p class="mb-1">å½“å‰æ€»æ¬ æ¬¾</p>
                    <h3 id="currentDebt">Â¥0.00</h3>
                    <small id="currentDate">-</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <div><i class="bi bi-graph-down-arrow" style="font-size: 2rem;"></i></div>
                    <p class="mb-1">è¿‘30å¤©å‡å°‘</p>
                    <h3 id="thirtyDayDecrease" class="trend-indicator">Â¥0.00</h3>
                    <small id="decreasePercent">-</small>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="alert alert-info mb-4">
            <h5><i class="bi bi-info-circle"></i> åŠŸèƒ½è¯´æ˜</h5>
            <p class="mb-2">ğŸ“Š <strong>å€ºåŠ¡è¶‹åŠ¿</strong> - æ¯å¤©è‡ªåŠ¨è®°å½•å€ºåŠ¡æ€»é¢ï¼Œå¯è§†åŒ–æ‚¨çš„è¿˜æ¬¾è¿›åº¦</p>
            <ul class="mb-0">
                <li>âœ… æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è®°å½•å¿«ç…§</li>
                <li>âœ… æ”¯æŒæŒ‰å¤©/æŒ‰æœˆæŸ¥çœ‹è¶‹åŠ¿</li>
                <li>âœ… ç›´è§‚çœ‹åˆ°å€ºåŠ¡å‡å°‘æƒ…å†µ</li>
                <li>ğŸ’¡ åšæŒè¿˜æ¬¾ï¼Œå€ºåŠ¡æ›²çº¿ä¼šè¶Šæ¥è¶Šä½ï¼</li>
            </ul>
        </div>

        <!-- å›¾è¡¨é€‰é¡¹ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5><i class="bi bi-graph-down"></i> å€ºåŠ¡è¶‹åŠ¿å›¾</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <!-- è§†å›¾åˆ‡æ¢ -->
                        <div class="btn-group me-3" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="btnDaily" onclick="switchView('daily')">
                                <i class="bi bi-calendar-day"></i> æŒ‰å¤©
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnMonthly" onclick="switchView('monthly')">
                                <i class="bi bi-calendar-month"></i> æŒ‰æœˆ
                            </button>
                        </div>
                        
                        <!-- æ—¶é—´èŒƒå›´ -->
                        <select class="form-select d-inline-block w-auto" id="rangeSelect" onchange="loadTrendData()">
                            <option value="7">æœ€è¿‘7å¤©</option>
                            <option value="30" selected>æœ€è¿‘30å¤©</option>
                            <option value="60">æœ€è¿‘60å¤©</option>
                            <option value="90">æœ€è¿‘90å¤©</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¶‹åŠ¿å›¾ -->
        <div class="card">
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="debtChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="createSnapshot()">
                <i class="bi bi-camera"></i> ç«‹å³åˆ›å»ºå¿«ç…§
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let chart = null;
        let currentView = 'daily'; // 'daily' or 'monthly'

        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadTrendData();
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE_URL}/debt-snapshot/statistics`);
                const stats = await response.json();
                
                document.getElementById('currentDebt').textContent = 
                    'Â¥' + Utils.formatMoney(stats.currentDebt || 0);
                document.getElementById('currentDate').textContent = 
                    stats.currentDate || '-';
                
                const decrease = stats.thirtyDayDecrease || 0;
                const decreaseEl = document.getElementById('thirtyDayDecrease');
                
                if (stats.hasDecrease && decrease > 0) {
                    decreaseEl.textContent = 'â†“ Â¥' + Utils.formatMoney(decrease);
                    decreaseEl.classList.add('text-success');
                    document.getElementById('decreasePercent').textContent = 'å¤ªæ£’äº†ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª';
                } else if (decrease < 0) {
                    decreaseEl.textContent = 'â†‘ Â¥' + Utils.formatMoney(Math.abs(decrease));
                    decreaseEl.classList.add('text-warning');
                    document.getElementById('decreasePercent').textContent = 'å€ºåŠ¡å¢åŠ äº†ï¼Œéœ€è¦æ³¨æ„ï¼';
                } else {
                    decreaseEl.textContent = 'Â¥0.00';
                    document.getElementById('decreasePercent').textContent = 'æš‚æ— å˜åŒ–';
                }
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('btnDaily').classList.toggle('active', view === 'daily');
            document.getElementById('btnMonthly').classList.toggle('active', view === 'monthly');
            
            // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
            const rangeSelect = document.getElementById('rangeSelect');
            if (view === 'daily') {
                rangeSelect.innerHTML = `
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="30" selected>æœ€è¿‘30å¤©</option>
                    <option value="60">æœ€è¿‘60å¤©</option>
                    <option value="90">æœ€è¿‘90å¤©</option>
                `;
            } else {
                rangeSelect.innerHTML = `
                    <option value="6">æœ€è¿‘6ä¸ªæœˆ</option>
                    <option value="12" selected>æœ€è¿‘12ä¸ªæœˆ</option>
                    <option value="24">æœ€è¿‘24ä¸ªæœˆ</option>
                `;
            }
            
            loadTrendData();
        }

        // åŠ è½½è¶‹åŠ¿æ•°æ®
        async function loadTrendData() {
            try {
                const range = document.getElementById('rangeSelect').value;
                const endpoint = currentView === 'daily' 
                    ? `${API_BASE_URL}/debt-snapshot/trend/daily?days=${range}`
                    : `${API_BASE_URL}/debt-snapshot/trend/monthly?months=${range}`;
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                renderChart(data);
                
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
                Utils.showError('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥');
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(data) {
            const ctx = document.getElementById('debtChart').getContext('2d');
            
            // é”€æ¯æ—§å›¾è¡¨
            if (chart) {
                chart.destroy();
            }
            
            // å‡†å¤‡æ•°æ®
            const labels = data.map(d => currentView === 'daily' ? d.dateDisplay : d.monthDisplay);
            const debtData = data.map(d => d.totalDebt);
            const paymentData = data.map(d => d.monthlyPayment);
            
            // åˆ›å»ºæ–°å›¾è¡¨
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ€»æ¬ æ¬¾',
                            data: debtData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'æœˆè¿˜æ¬¾é¢',
                            data: paymentData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'Â¥' + Utils.formatMoney(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + Utils.formatMoney(value);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // æ‰‹åŠ¨åˆ›å»ºå¿«ç…§
        async function createSnapshot() {
            if (!confirm('ç¡®è®¤åˆ›å»ºä»Šå¤©çš„å€ºåŠ¡å¿«ç…§å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/debt-snapshot/create`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    Utils.showSuccess('å¿«ç…§åˆ›å»ºæˆåŠŸï¼');
                    loadStatistics();
                    loadTrendData();
                } else {
                    Utils.showError('åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºå¿«ç…§å¤±è´¥:', error);
                Utils.showError('åˆ›å»ºå¿«ç…§å¤±è´¥');
            }
        }
    </script>
</body>
</html>

