# 自动更新还款期数功能说明

## 功能概述

系统现在支持**自动更新已还期数**功能，过了还款日后自动增加"已还期数"，无需手动操作。

## 工作原理

### 定时任务
- **执行时间**：每天凌晨 3:00
- **执行频率**：每天一次
- **执行顺序**：在债务快照任务（凌晨2点）之后执行

### 更新逻辑

```
对于每一笔活跃贷款：
1. 检查今天是否 >= 还款日
2. 检查本月是否已经自动更新过
3. 如果满足条件，自动执行：
   - 已还期数 +1
   - 重新计算剩余金额 = 月还款 × (总期数 - 已还期数)
   - 如果已还期数 >= 总期数，自动标记为"已结清"
```

### 防重复机制

通过检查 `updatedAt` 字段判断本月是否已经更新过：
- 如果 `updatedAt` 不在本月，则执行更新
- 如果 `updatedAt` 已经在本月，跳过更新

## 配置说明

### 开启/关闭自动更新

在 `application.yml` 中配置：

```yaml
loan:
  auto-update:
    enabled: true  # true=启用，false=禁用
```

**默认值**：`true`（已启用）

### 配置建议

✅ **推荐启用**（`enabled: true`）如果：
- 您能够保证每月按时还款
- 您希望系统自动维护数据
- 您不想每月手动更新"已还期数"

⚠️ **建议禁用**（`enabled: false`）如果：
- 您可能会延迟还款或漏还
- 您希望完全手动控制数据
- 您需要更精确的还款记录

## 手动触发

如果禁用了自动更新，或者需要立即更新，可以手动触发：

### API 方式

```bash
POST /api/system/update-paid-periods
```

### 前端调用示例

```javascript
await fetch('http://localhost:8080/api/system/update-paid-periods', {
    method: 'POST'
});
```

## 使用场景

### 场景1：按时还款用户（推荐）

```yaml
loan:
  auto-update:
    enabled: true
```

- ✅ 每月还款日后自动更新
- ✅ 无需手动操作
- ✅ 还清时自动标记为"已结清"

### 场景2：需要精确控制的用户

```yaml
loan:
  auto-update:
    enabled: false
```

- ✅ 每次还款后通过"记录还款"功能手动记录
- ✅ 更精确的还款历史
- ✅ 可以处理提前还款、延迟还款等特殊情况

### 场景3：测试或补录数据

```bash
# 手动触发一次性更新
POST /api/system/update-paid-periods
```

## 日志记录

系统会记录所有自动更新操作：

```log
[INFO] 已自动更新贷款 [拍拍贷] 的已还期数: 2 -> 3
[INFO] 定时任务完成：已自动更新 5 笔贷款的还款期数
[INFO] 贷款 [借呗] 已自动标记为已结清
```

## 注意事项

### ⚠️ 重要提醒

1. **假设按时还款**
   - 自动更新假设您每月按时还款
   - 如果某月未还款，可能需要手动调整

2. **不影响还款历史**
   - 自动更新只增加"已还期数"
   - 不会创建还款历史记录
   - 不会自动扣减余额

3. **与手动还款并存**
   - 启用自动更新后，仍可使用"记录还款"功能
   - "记录还款"会创建详细的还款历史

4. **时区问题**
   - 定时任务使用服务器时区
   - 确保服务器时间正确

## 工作流程图

```
                    凌晨 3:00
                        ↓
            自动更新任务触发
                        ↓
            检查是否启用 (enabled)
                        ↓
                是     否
                ↓      ↓
          遍历活跃贷款  跳过
                ↓
        今天 >= 还款日？
                ↓
            是      否
            ↓       ↓
      本月已更新？  跳过
            ↓
        否      是
        ↓       ↓
    执行更新   跳过
        ↓
    已还期数 +1
        ↓
   重新计算剩余金额
        ↓
    是否已还清？
        ↓
    是          否
    ↓           ↓
标记为已结清  保持活跃
```

## 技术实现

### 定时任务配置

```java
@Scheduled(cron = "0 0 3 * * ?")  // 每天凌晨3点
@Transactional
public void autoUpdatePaidPeriods() {
    // ...
}
```

### Cron 表达式说明

```
0 0 3 * * ?
│ │ │ │ │ │
│ │ │ │ │ └─ 星期几（忽略）
│ │ │ │ └─── 月份（每月）
│ │ │ └───── 日期（每天）
│ │ └─────── 小时（3点）
│ └───────── 分钟（0分）
└─────────── 秒（0秒）
```

## FAQ

### Q1: 如果某月忘记还款怎么办？

**A**: 
- 如果启用了自动更新，系统会按时增加已还期数，这可能导致数据不准确
- 建议：禁用自动更新，或者手动调整"已还期数"

### Q2: 自动更新会扣减余额吗？

**A**: 
- 不会！自动更新只增加"已还期数"和更新"剩余金额"
- 不会影响"当前余额"
- 如果需要记录余额变化，请使用"记录还款"功能

### Q3: 可以修改定时任务执行时间吗？

**A**: 
- 可以，修改 `LoanAutoUpdateService.java` 中的 `@Scheduled(cron = "...")`
- 例如改为每天早上8点：`@Scheduled(cron = "0 0 8 * * ?")`

### Q4: 如何知道自动更新是否执行了？

**A**: 
- 查看日志文件
- 检查贷款的 `updatedAt` 时间
- 比对"已还期数"的变化

### Q5: 启用自动更新后，还能手动记录还款吗？

**A**: 
- 可以！两者不冲突
- 建议：如果启用自动更新，就不要再手动更新"已还期数"
- 但可以使用"记录还款"功能来创建详细的还款历史

## 总结

自动更新还款期数功能可以大大简化日常操作，特别适合能够按时还款的用户。如果您有特殊需求或需要更精确的控制，可以随时禁用此功能。

---

如有任何问题，请随时反馈！

